var qe=Object.defineProperty;var Qe=(i,l,s)=>l in i?qe(i,l,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[l]=s;var b=(i,l,s)=>Qe(i,typeof l!="symbol"?l+"":l,s);import{j as r,r as d}from"./index-Bl-ZOWkZ.js";import{O as ie,Q as Ve,d as Je,f as Ye,L as $e,w as Ze}from"./storyArgs-CNybPO01.js";import{u as Ke}from"./useQuery-CidFMm36.js";import{D as ye,N as Xe}from"./ts4nfdiGraphStyle-DEBK50Pl.js";import{E as et}from"./button-Bc5sVomR.js";import{E as tt}from"./popover-Df51L6yb.js";import{E as we,a as rt}from"./text-CwK6QkCY.js";import{E as it}from"./button_empty-BCDH6Gc9.js";import{E as Te}from"./panel-DxNbXEZo.js";import{E as W}from"./icon-CE3ukyQW.js";const Ce={enabled:!0,direction:"DU",sortMethod:"directed"},_={autoResize:!0,height:"100%",width:"100%",locale:"en",layout:{randomSeed:1,improvedLayout:!0,clusterThreshold:150,hierarchical:{enabled:!1}},physics:{enabled:!0,barnesHut:{gravitationalConstant:-2e4,centralGravity:.3,springLength:10,springConstant:.04,damping:.09,avoidOverlap:0},hierarchicalRepulsion:{damping:.09,avoidOverlap:.9}},interaction:{dragNodes:!0,dragView:!0,zoomView:!0}};class te{constructor(l,s="#455469",u="white"){b(this,"id");b(this,"color");b(this,"shape");b(this,"font");b(this,"label");this.id=l.iri,this.label=l.label,this.color={background:s,highlight:{border:"#404040",background:"#404040"}},this.shape="box",this.font={color:u}}}class ot{constructor(l,s="is a"){b(this,"id");b(this,"from");b(this,"to");b(this,"label");b(this,"arrows");b(this,"width");b(this,"color");b(this,"font");b(this,"dashes");l.source&&l.target&&l.uri&&(this.id=l.source+l.target+"&uri="+l.uri,this.from=l.source,this.to=l.target,this.label=s,this.arrows={to:!0},this.width=2,this.color={color:"gray",highlight:"#00617C"},this.font={size:16})}}async function nt(i){const{api:l,ontologyId:s,iri:u,targetIri:h,dbClicked:E}=i,g=new ie(l);let y=await g.getTermTree({ontologyId:s,termIri:u},{viewMode:"All",siblings:!1},i.parameter);if(h&&!E){let T=await g.getTermTree({ontologyId:s,termIri:h},{viewMode:"All",siblings:!1},i.parameter);return{treeData:y,targetTreeData:T}}return{treeData:y}}async function st(i){const{api:l,ontologyId:s,iri:u,targetIri:h,dbClicked:E}=i,g=new ie(l);let y=await g.getTermTree({ontologyId:s,termIri:u},{viewMode:"All",siblings:!1},i.parameter),T=await g.getTermRelations({ontologyId:s,termIri:u},i.parameter);if(h&&!E){let D=await g.getTermTree({ontologyId:s,termIri:h},{viewMode:"All",siblings:!1},i.parameter),H=await g.getTermRelations({ontologyId:s,termIri:h},i.parameter);return{treeData:y,termRelations:T,targetTreeData:D,targetTermRelations:H}}return{treeData:y,termRelations:T}}async function lt(i){const{api:l,ontologyId:s,iri:u,targetIri:h,dbClicked:E}=i,g=new ie(l);let y=await g.getTermRelations({ontologyId:s,termIri:u},i.parameter);if(h&&!E){let T=await g.getTermRelations({ontologyId:s,termIri:h},i.parameter);return{termRelations:y,targetTermRelations:T}}return{termRelations:y}}function ke(i){let l=[];for(let s of i){if(s.parent==="#"){l.push(s);continue}for(let u of i)u.id===s.parent&&("childrenList"in u?u.childrenList.push(s):u.childrenList=[s],"parentList"in s?s.parentList.push(u):s.parentList=[u])}return l}const z=["http://www.w3.org/2000/01/rdf-schema#subClassOf","hierarchicalParent","directParent"],re="has part";function at(i){const{api:l,iri:s,ontologyId:u,rootWalk:h,className:E,hierarchy:g,edgeLabel:y,onNodeClick:T,parameter:D}=i,[H,oe]=d.useState(s),[I,U]=d.useState(!0),[q,Q]=d.useState(!1),[m,V]=d.useState(!1),[Re,ne]=d.useState(!1),[M,J]=d.useState(0),[se,je]=d.useState({nodes:[],edges:[]}),[F,le]=d.useState(""),[Y,ve]=d.useState({bgColor:"",color:""}),[Se,ae]=d.useState(!1),[$,Z]=d.useState(!1),[A,ce]=d.useState(!1),[C,Ee]=d.useState(i.targetIri??""),[de,Ie]=d.useState(""),[ue,Ne]=d.useState(""),Le=E||"ts4nfdi-graph-style",K=!y||y==="undefined"?"is a":y,Ge=typeof T=="function"&&!T.name.includes("actionHandler"),X="#139ec4",L="#708238",ge="#00a86b",fe="#ff991c",j="white",{data:f,isLoading:Oe,isError:De,error:Me}=Ke(["termGraph",l,u,h,g,m,C,M],async()=>{let e=s;if(m&&(e=H),h&&(I||m)&&!g)return await nt({api:l,iri:e,ontologyId:u,targetIri:C,dbClicked:m,parameter:D});if(h&&(I||m)&&g)return await st({api:l,iri:e,ontologyId:u,targetIri:C,dbClicked:m,parameter:D});if(I||m)return await lt({api:l,iri:e,ontologyId:u,targetIri:C,dbClicked:m,parameter:D})}),x=d.useRef(new ye([])),G=d.useRef(new ye([])),w=d.useRef({}),he=d.useRef(null),ee=d.useRef(null),P=d.useRef(new Map);if(g&&(_.layout.hierarchical=Ce),f&&(I||m)){let e={...se},o={nodes:[],edges:[]};o=f.termRelations??o,f.treeData&&h&&(I||m)&&!g?o=be(f.treeData,f.termRelations,f.targetTreeData,f.targetTermRelations):f.termRelations&&f.treeData&&h&&(I||m)&&g&&(o=be(f.treeData,f.termRelations,f==null?void 0:f.targetTreeData,f==null?void 0:f.targetTermRelations)),!h&&!g&&(o.nodes=Fe(f),o.edges=Ae(f),Q(!0)),I&&(e={nodes:[],edges:[]},U(!1)),m&&V(!1),je({nodes:[...e.nodes,...(o==null?void 0:o.nodes)??[]],edges:[...e.edges,...(o==null?void 0:o.edges)??[]]}),Q(!0)}function Fe(e){var c,t,p;let o=x.current.length;for(let a of((c=e.termRelations)==null?void 0:c.nodes)??[])v(a);let n=[];if(e.targetTermRelations){for(let a of e.targetTermRelations.nodes)(t=e==null?void 0:e.termRelations)!=null&&t.nodes.find(k=>k.iri===a.iri)?v(a,!0):n.push(a);for(let a of n)v(a,!1,L,j)}return o===x.current.length&&Z(!0),[...((p=e.termRelations)==null?void 0:p.nodes)??[],...n]}function Ae(e){var n,c,t,p;for(let a of((n=e.termRelations)==null?void 0:n.edges)??[]){if(!z.includes(a.uri)){O(a,a.label);continue}O(a)}let o=[];if((c=e.targetTermRelations)!=null&&c.edges)for(let a of e.targetTermRelations.edges)(t=e.termRelations)!=null&&t.edges.find(k=>k.source===a.source&&k.target===a.target)||(O(a),o.push(a));return[...((p=e.termRelations)==null?void 0:p.edges)??[],...o]}function v(e,o=!1,n="",c=""){let t=new te(e=e);n&&c&&(t=new te(e=e,L,j)),x.current.get(t.id)?o&&t.id!==s&&t.id!==C&&(t=new te(e=e,fe),x.current.remove(t.id),P.current.set(t.id??"",t.color.background),x.current.add(t)):(t.id===s?(Ie(t.label??""),t.color.background=X,t.font.color=j):C&&t.id===C?(Ne(t.label??""),t.color.background=ge,t.font.color=j):P.current.get(t.id)?t.color.background=P.current.get(t.id):m&&Y.bgColor&&Y.bgColor!==X&&(t.color.background=Y.bgColor,t.font.color=j),P.current.set(t.id??"",t.color.background),x.current.add(t))}function O(e,o=K){var t;let n=new ot(e=e,o),c=!(z.includes(e.uri??"")||h);n.dashes=c,G.current.get(n.id)||((t=n.id)!=null&&t.includes(s)&&h&&(n.color.color="black"),G.current.add(n))}function pe(e,o,n=!1){let c=[...o],t=[],p=1,a=[],k=x.current.length;for(;;){let R=c[0];c=c.slice(1);let S={iri:R.iri,label:R.text,level:p};if(n?e.nodes.find(N=>N.iri===S.iri)?v(S,!0,L,j):(v(S,!1,L,j),a.find(N=>N.iri===S.iri)||a.push(S)):(e.nodes.find(N=>N.iri===S.iri)||e.nodes.push(S),v(S)),R.parentList&&R.parentList.length!==0&&R.parentList.forEach(N=>{let B={source:R.iri,target:N.iri,label:K,uri:z[0]};e.edges.find(xe=>xe.source===B.source&&xe.target===B.target)||e.edges.push(B),O(B)}),R.childrenList&&R.childrenList.length!==0&&t.push(...R.childrenList),c.length===0){if(t.length===0)break;p+=1,c.push(...t),t=[]}}return e.nodes=[...e.nodes,...a],k===x.current.length&&Z(!0),e}function me(e,o,n=!1){if(!o)return;let c="",t="";n&&(c=L,t=j);let p={nodes:[],edges:[]};for(let a of o.edges)a.label===re&&(O(a,re),v(o.nodes.find(k=>k.iri===a.source),!1,c,t),v(o.nodes.find(k=>k.iri===a.target),!1,c,t));e.nodes=e.nodes.concat(p.nodes),e.edges=e.edges.concat(p.edges)}function be(e,o,n,c){let t={nodes:[],edges:[]},p=ke(e);if(pe(t,p),m||me(t,o),C&&n){let a=ke(n);pe(t,a,!0),m||me(t,c,!0)}return t}function Pe(){const e=JSON.stringify(se,null,2),o=new Blob([e],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(o),n.download=`graphData_${u}_${s}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n)}function Be(){x.current.clear(),G.current.clear(),oe(s),U(!0),V(!1),J(M+1)}function We(){if(!F)ae(!0),setTimeout(()=>{ae(!1)},3e3);else{let e=[],o=[];G.current.forEach((n,c)=>{n.label!==re&&(n.to===F?e.push(n.from):n.from===F&&o.push(n.to))});for(let n of e)for(let c of o){let t={source:n,target:c,label:K,uri:z[0]};O(t)}x.current.remove(F),w.current.setOptions({physics:!0}),setTimeout(()=>{w.current.setOptions({physics:!1})},4e3)}}d.useEffect(()=>{if(!q)return;let e={nodes:x.current,edges:G.current},o=JSON.parse(JSON.stringify(_));w.current=new Xe(he.current,e,o),setTimeout(()=>{w.current.setOptions({physics:!1})},4e3)},[M,q]),d.useEffect(()=>{w.current&&q&&(w.current.on("click",function(e){e.nodes.length>0?le(e.nodes[0]):le("")}),w.current.on("doubleClick",function(e){var o,n,c,t;if(e.nodes.length>0){let p=e.nodes[0];ve({bgColor:(n=(o=x.current.get(p))==null?void 0:o.color)==null?void 0:n.background,color:(t=(c=x.current.get(p))==null?void 0:c.font)==null?void 0:t.color}),oe(p),Ge?T(p):V(!0)}}))},[w.current]),d.useEffect(()=>{i.targetIri&&C!==i.targetIri&&(Q(!1),w.current.destroy(),x.current.clear(),G.current.clear(),Ee(i.targetIri),U(!0),J(M+1))},[i.targetIri]),d.useEffect(()=>{g?_.layout.hierarchical=Ce:_.layout.hierarchical={enabled:!1},J(M+1)},[g]),d.useEffect(()=>{m&&(w.current.setOptions({physics:!0}),setTimeout(()=>{w.current.setOptions({physics:!1})},4e3))},[m]),d.useEffect(()=>{$&&setTimeout(()=>{Z(!1)},3e3)},[$]);const _e=()=>ne(e=>!e),ze=()=>ne(!1),He=r.jsx(it,{iconType:"iInCircle",iconSide:"right",onClick:_e,children:"Guide me"}),Ue=()=>{document.fullscreenElement?(document.exitFullscreen(),ce(!1)):ee.current&&(ee.current.requestFullscreen(),ce(!0))};return r.jsx("div",{className:Le,style:{width:"1000px",height:"100vh",overflow:"hidden"},ref:ee,children:r.jsxs(Te,{style:{height:"100vh"},"data-testid":"graph-widget",children:[De&&r.jsx(we,{children:$e(Me,"graph")}),r.jsxs(Te,{style:{fontSize:12},paddingSize:"s",borderRadius:"none","data-testid":"graph-view",children:[r.jsx(et,{size:"s",onClick:Be,"aria-label":"reset the graph to default view",title:"Reset the graph to the original state.",style:{textDecoration:"none"},children:"Reset"}),!A&&r.jsx(tt,{button:He,isOpen:Re,closePopover:ze,children:r.jsxs(we,{style:{width:300,padding:10},children:[r.jsx("li",{children:"Expand the nodes by double clicking on them"}),r.jsx("li",{children:"Zoom out/in by scrolling on the graph."}),r.jsx("li",{children:"Go to fullscreen mode by clicking the fullscreen icon on the right corner."}),r.jsx("li",{children:"Download the graph data as JSON by clicking the download icon on the right corner."}),r.jsx("li",{children:"You can go back to the initial graph by clicking on the Reset button."}),r.jsx("li",{children:"You can move the nodes and edges around by dragging."})]})}),$&&r.jsx("div",{style:{display:"inline-block",backgroundColor:"#FBCBC6",color:"red",padding:"5px",borderRadius:"10px"},children:"nothing to add"}),r.jsxs("div",{style:{display:"inline-flex",float:"right",paddingTop:10},children:[r.jsx("button",{onClick:We,style:{marginRight:"20px",color:"red"},title:"Remove node","aria-label":"remove the selected node from graph",children:r.jsx(W,{type:"cut"})}),Se&&r.jsx(rt,{color:"red",style:{marginTop:"10px",marginRight:"10px",marginLeft:"-10px"},children:"Please select a node to remove"}),r.jsx("button",{onClick:Pe,title:"Download graph data as json.","aria-label":"download graph data as json",children:r.jsx(W,{type:"download"})}),r.jsx("button",{onClick:Ue,style:{marginLeft:"20px"},title:A?"Exit fullscreen mode":"Fullscreen mode","aria-label":A?"exit fullscreen mode":"go to fullscreen mode",children:A?r.jsx(W,{type:"fullScreenExit"}):r.jsx(W,{type:"fullScreen"})})]})]}),Oe&&r.jsx(Ze,{size:"m"}),r.jsx("div",{ref:he,className:"graph-container",style:{width:"100%",height:"100vh",margin:"auto"}}),r.jsxs("div",{style:{position:"absolute",display:"inline-block",backgroundColor:"#e5e7ea",padding:"5px",borderRadius:"10px",paddingTop:"10px",bottom:"20px",right:"20px"},children:[r.jsx("b",{children:"Legend:"}),r.jsxs("ul",{style:{paddingTop:"15px"},children:[r.jsxs("li",{style:{paddingTop:"5px"},children:[r.jsx("div",{style:{backgroundColor:X,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block"}}),"  Source: ",r.jsx("i",{children:de})," "]}),C&&r.jsxs(r.Fragment,{children:[r.jsxs("li",{style:{paddingTop:"5px"},children:[r.jsx("div",{style:{backgroundColor:"#455469",width:"10px",height:"10px",borderRadius:"50%",display:"inline-block"}}),"  Subtree exclusive to ",r.jsx("i",{children:de})," "]}),r.jsxs("li",{style:{paddingTop:"5px"},children:[r.jsx("div",{style:{backgroundColor:fe,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block"}}),"  Common subtree "]}),r.jsxs("li",{style:{paddingTop:"5px"},children:[r.jsx("div",{style:{backgroundColor:ge,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block"}})," Target: ",r.jsx("i",{children:ue})," "]}),r.jsxs("li",{style:{paddingTop:"5px"},children:[r.jsx("div",{style:{backgroundColor:L,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block"}}),"  Subtree exclusive to ",r.jsx("i",{children:ue})," "]})]})]})]}),r.jsx("style",{children:`
        .graph-container:fullscreen,
        .graph-container::backdrop {
          background-color: white;
        }
      `})]})})}function wt(i){const l=new Ve;return r.jsx(Je,{colorMode:"light",globalStyles:!1,children:r.jsx(Ye,{client:l,children:r.jsx(at,{api:i.api,iri:i.iri,ontologyId:i.ontologyId,rootWalk:i.rootWalk,hierarchy:i.hierarchy,edgeLabel:i.edgeLabel,onNodeClick:i.onNodeClick,targetIri:i.targetIri,parameter:i.parameter})})})}export{at as G,wt as W};

var Q=Object.defineProperty;var X=(t,e,a)=>e in t?Q(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var v=(t,e,a)=>X(t,typeof e!="symbol"?e+"":e,a);import{j as o,r as R,c as Y}from"./index-Bl-ZOWkZ.js";import{aS as K,aT as j,aR as N,aU as P,aV as B,aW as O,Q as q,d as z,f as V,aq as S,aX as H,aY as Z,w as W,R as ee}from"./storyArgs-CNybPO01.js";import{u as te}from"./useQuery-CidFMm36.js";/* empty css                  *//* empty css                              */import{E as ie}from"./ExpandableOntologyBadgeList-DuPGoLJ-.js";import{E as ne}from"./panel-DxNbXEZo.js";import{E as ae}from"./text-CwK6QkCY.js";import{E as $}from"./icon-CE3ukyQW.js";class D{static fromTopConcept(e){return{iri:e.uri,label:e.label,hasChildren:e.hasChildren,parents:[]}}static fromHierarchyResult(e){return{iri:e.uri,label:e.prefLabel,hasChildren:e.narrower!=null&&e.narrower.length>0,parents:N.fromJson(e.broader)}}static fromPrefAndUriAndChildren(e,a){return{iri:e.uri,label:e.prefLabel,hasChildren:e.hasChildren,parents:N.fromJson(a)}}static fromLabelAndUriAndChildren(e,a){return{iri:e.uri,label:e.label,hasChildren:e.hasChildren,parents:N.fromJson(a)}}}class A{constructor(e){v(this,"axiosInstance");this.axiosInstance=K.create({baseURL:e,headers:{Accept:"application/json"}})}async makeCall(e,a){return(await this.axiosInstance.get(e,a)).data}async buildHierarchyWithIri(e){var b,s;const{iri:a,ontologyId:d,showSiblingsOnInit:y,parameter:I}=e;if(!d)throw Error("ontologyId has to be specified for SKOS API.");const p=[],u=new Map,f=new Map,E=new Set,m=new Set;if(a){const i=await this.makeCall(`/${d}/hierarchy`,{params:{uri:a,lang:"en",format:"application/json",...j(I)}}).then(r=>Object.keys(r.broaderTransitive).map(l=>r.broaderTransitive[l]));for(const r of i){const l=D.fromHierarchyResult(r);f.set(l.iri,l),r.top&&p.push(l.iri),y||m.add(l.iri)}for(const r of i)if(r.narrower!=null){const l=[];for(const c of r.narrower){let n=f.get(c.uri);n==null?(n=D.fromLabelAndUriAndChildren(c,[r.uri]),f.set(n.iri,n)):(b=n==null?void 0:n.parents)!=null&&b.map(w=>w.value).includes(r.uri)||n!=null&&n.parents&&((s=n==null?void 0:n.parents)==null||s.push(...N.fromJson(r.uri))),l.push(n)}l.sort((c,n)=>(c.label||c.iri).localeCompare(n.label||n.iri)),u.set(r.uri,l.map(c=>({childIri:c.iri}))),E.add(r.uri)}}else{const i=await this.makeCall(`/${d}/topConcepts`,{params:{lang:"en",format:"application/json",...j(I)}}).then(r=>r.topconcepts);for(const r of i)p.push(r.uri)}function x(i,r){r.add(i.iri);const l=new B(i),c=u.get(i.iri)||[];if(y)for(const n of c){if(r.has(n.childIri)){console.error(`Cyclic tree at entity "${n.childIri}".`);continue}const w=f.get(n.childIri);w!=null&&l.addChild(x(w,r))}else for(const n of c){if(r.has(n.childIri)){console.error(`Cyclic tree at entity "${n.childIri}".`);continue}const w=f.get(n.childIri);w!=null&&m.has(n.childIri)&&l.addChild(x(w,r))}return l.loadedChildren.length>0&&(l.expanded=!0),r.delete(i.iri),l}const T=new Set,C=p.map(i=>x(f.get(i),T)).sort((i,r)=>(i.entityData.label||i.entityData.iri).localeCompare(r.entityData.label||r.entityData.iri));return new P({parentChildRelations:u,entitiesData:f,allChildrenPresent:E,roots:C,api:new A(this.axiosInstance.getUri()),ontologyId:d,mainEntityIri:a,keepExpansionStates:e.keepExpansionStates,parameter:I})}async loadHierarchyChildren(e){const{nodeToExpand:a,ontologyId:d,parameter:y}=e;return(await this.makeCall(`/${d}/children`,{params:{uri:a.entityData.iri,lang:"en",format:"application/json",...j(y)}})).narrower.map(p=>D.fromPrefAndUriAndChildren(p,[a.entityData.iri]))}}function _(t){return{iri:t["@id"],label:t.prefLabel,hasChildren:t.hasChildren,parents:[]}}class L{constructor(e,a){v(this,"axiosInstance");v(this,"apiKey");this.axiosInstance=K.create({baseURL:e,headers:{Accept:"application/json"}}),this.apiKey=a,this.axiosInstance.interceptors.request.use(d=>(d.params=d.params||{},d.params.apikey=this.apiKey,d.params.format="json",d))}async makeCall(e,a){return(await this.axiosInstance.get(e,a)).data}async buildHierarchyWithIri(e){const{iri:a,ontologyId:d,entityType:y,showSiblingsOnInit:I}=e;if(!d)throw Error("ontologyId has to be specified for OntoPortal API.");if(!y)throw Error("entityType has to be specified for OntoPortal API.");const p=[],u=new Map,f=new Map,E=new Set,m=new Set;function x(s){if(u.set(s["@id"],_(s)),s.hasChildren&&s.children.length>0){f.set(s["@id"],s.children.map(i=>({childIri:i["@id"]}))),E.add(s["@id"]),m.add(s["@id"]);for(const i of s.children)x(i)}}if(a){const s=await this.makeCall(`/ontologies/${d.toUpperCase()}/${O(y,!1)}/${encodeURIComponent(a)}/tree`,{params:{include:"@id,prefLabel,hasChildren,children",language:"EN"}});for(const i of s)p.push(i["@id"]),m.add(i["@id"]),x(i);m.add(a)}else{const s=await this.makeCall(`/ontologies/${d.toUpperCase()}/${O(y,!1)}/roots`,{params:{include:"@id,prefLabel,hasChildren",language:"EN"}});for(const i of s)p.push(i["@id"]),m.add(i["@id"])}function T(s,i){i.add(s.iri);const r=new B(s),l=f.get(s.iri)||[];if(I)for(const c of l){if(i.has(c.childIri)){console.error(`Cyclic tree at entity "${c.childIri}".`);continue}r.addChild(T(u.get(c.childIri),i))}else for(const c of l){if(i.has(c.childIri)){console.error(`Cyclic tree at entity "${c.childIri}".`);continue}m.has(c.childIri)&&r.addChild(T(u.get(c.childIri),i))}return r.loadedChildren.length>0&&(r.expanded=!0),i.delete(s.iri),r}const C=new Set,b=p.map(s=>T(u.get(s),C)).sort((s,i)=>(s.entityData.label||s.entityData.iri).localeCompare(i.entityData.label||i.entityData.iri));return new P({parentChildRelations:f,entitiesData:u,allChildrenPresent:E,roots:b,api:new L(this.axiosInstance.getUri(),this.apiKey),ontologyId:d,mainEntityIri:a,keepExpansionStates:e.keepExpansionStates,entityType:y})}async loadHierarchyChildren(e){const{nodeToExpand:a,ontologyId:d,entityType:y}=e;if(y==null)throw Error("entityType has to be provided to load children in an OntoPortal hierarchy.");return(await this.makeCall(`/ontologies/${d.toUpperCase()}/${O(y,!1)}/${encodeURIComponent(a.entityData.iri)}/children`,{params:{include:"@id,prefLabel,hasChildren",language:"EN"}})).collection.map(p=>_(p))}}function re(t){let e=t.entityData.definedBy||[];return e.includes(t.ontologyId)&&(e=[]),o.jsxs("span",{style:{position:"relative",left:"16px",lineHeight:"20px"},children:[o.jsxs("span",{className:t.highlight?"highlight":void 0,children:[t.childRelationToParent=="http://purl.obolibrary.org/obo/BFO_0000050"&&o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"surroundCircle",children:" P "})," "]}),t.childRelationToParent=="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"&&o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"surroundCircle",children:"I"})," "]}),o.jsx("a",{onClick:()=>{typeof t.onNavigateToEntity=="function"&&t.onNavigateToEntity(t.ontologyId,t.entityType||"",t.entityData)},style:{textAlign:"left",color:"unset",cursor:"pointer"},children:o.jsx("span",{children:t.entityData.label||t.entityData.iri})})]}),o.jsxs("span",{children:[" ",o.jsx(ie,{iri:t.entityData.iri,ontolist:e,label:t.entityData.label||"",entityType:t.entityType,onNavigateToOntology:t.onNavigateToOntology}),t.entityData.numDescendants!=null&&t.entityData.numDescendants>0&&o.jsxs("span",{style:{color:"gray"},children:[" ","(",t.entityData.numDescendants.toLocaleString(),")"]})]})]})}function oe(t){const{apiUrl:e,backendType:a,apiKey:d,onNavigateToEntity:y,onNavigateToOntology:I,iri:p,ontologyId:u,entityType:f,includeObsoleteEntities:E=S.INCLUDE_OBSOLETE_ENTITIES,preferredRoots:m=S.PREFERRED_ROOTS,keepExpansionStates:x=S.KEEP_EXPANSION_STATES,showSiblingsOnInit:T=S.SHOW_SIBLINGS_ON_INIT,useLegacy:C=S.USE_LEGACY,hierarchyWrap:b=S.WRAP,className:s,parameter:i}=t,r=s||"ts4nfdi-hierarchy-style",[,l]=R.useReducer(h=>h+1%Number.MAX_SAFE_INTEGER,0),c=R.useMemo(()=>{switch(a){case"ols":return new H(e);case"skosmos":return new A(e);case"ontoportal":return new L(e,d||"");default:return new H(e)}},[e,a,d]),{data:n,isSuccess:w}=te(["hierarchySemLookP",p,f,u,m,E,x,T,C,i],async function(){return await c.buildHierarchyWithIri({ontologyId:u,iri:p,entityType:f,preferredRoots:m,includeObsoleteEntities:E,keepExpansionStates:x,showSiblingsOnInit:T,useLegacy:C,parameter:i})},{refetchOnWindowFocus:!1}),M=R.useCallback(h=>{if(!(n instanceof P))throw Error("Hierarchy object was undefined while trying to expand a tree node. This should never happen.");n.entityType&&Z(n.entityType)||(h.expanded=!h.expanded,h.expanded?(h.loading=!0,l(),n.fetchInformationForExpansion(h).then(()=>{h.loading=!1,l()})):(l(),n.closeNode(h)))},[n]);function U(h,g,k){return o.jsxs("div",{children:[o.jsxs("div",{style:{position:"relative"},children:[o.jsx("div",{style:{position:"absolute"},children:g.entityData.hasChildren?o.jsxs("button",{style:{},onClick:()=>{M(g)},children:[o.jsx($,{type:g.expanded?"arrowDown":"arrowRight",size:"s"})," "]}):o.jsx($,{type:"empty"})}),o.jsx("div",{className:"lineNodeInlet"}),o.jsx("div",{className:k?"lineAfterNodeInlet":""}),o.jsx(re,{entityData:g.entityData,childRelationToParent:g.childRelationToParent,ontologyId:h.ontologyId,entityType:h.entityType,onNavigateToEntity:typeof y=="function"?y:()=>{},onNavigateToOntology:typeof I=="function"?I:()=>{},highlight:g.entityData.iri==(h==null?void 0:h.mainEntityIri)})]}),g.expanded&&o.jsx("ul",{style:{marginBlockEnd:"0",marginInlineStart:"5px"},children:g.loading?o.jsx(W,{style:{position:"relative",left:"13px",top:"5px"}}):g.loadedChildren.map((G,J)=>o.jsx("div",{className:k?"outerLine":"",style:{paddingLeft:"1rem"},children:U(h,G,J<g.loadedChildren.length-1)},ee()))})]})}return o.jsx("div",{className:r,children:o.jsx(ne,{"data-testid":"hierarchy",style:{overflowX:"auto",overflowY:"hidden"},children:w&&n!=null?o.jsx(ae,{style:{whiteSpace:b?"wrap":"nowrap"},children:n.roots.map((h,g)=>U(n,h,g<n.roots.length-1))}):o.jsx(W,{})})})}function se(t){const e=new q;return o.jsx(z,{colorMode:"light",globalStyles:!1,children:o.jsx(V,{client:e,children:o.jsx(oe,{apiUrl:t.apiUrl,apiKey:t.apiKey,backendType:t.backendType,iri:t.iri,entityType:t.entityType,ontologyId:t.ontologyId,includeObsoleteEntities:t.includeObsoleteEntities,useLegacy:t.useLegacy,preferredRoots:t.preferredRoots,keepExpansionStates:t.keepExpansionStates,showSiblingsOnInit:t.showSiblingsOnInit,onNavigateToEntity:t.onNavigateToEntity,onNavigateToOntology:t.onNavigateToOntology,parameter:t.parameter,hierarchyWrap:t.hierarchyWrap})})})}const F=new WeakMap;function le(t,e){let a=F.get(e);a||(a=Y.createRoot(e),F.set(e,a)),a.render(o.jsx(se,{...t}))}window.ts4nfdiWidgets={...window.ts4nfdiWidgets,createHierarchy:le};export{oe as H,le as c};

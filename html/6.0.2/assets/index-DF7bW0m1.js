var J=Object.defineProperty;var X=(t,e,i)=>e in t?J(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var S=(t,e,i)=>X(t,typeof e!="symbol"?e+"":e,i);import{j as r,r as j,c as Y}from"./index-ZCdkkhYt.js";import{aL as K,aM as R,aK as N,aN as P,aO as M,aP as D,Q as q,d as z,f as V,ag as v,aQ as H,aR as Z,v as $,R as ee}from"./storyArgs-AFjXh7XW.js";import{u as te}from"./useQuery-BSQecOR7.js";/* empty css                  *//* empty css                              */import{E as ie}from"./panel-DRTqr2vT.js";import{E as ne}from"./text-dCu-lByA.js";import{E as W}from"./icon-RvlT3YZ5.js";class O{static fromTopConcept(e){return{iri:e.uri,label:e.label,hasChildren:e.hasChildren,parents:[]}}static fromHierarchyResult(e){return{iri:e.uri,label:e.prefLabel,hasChildren:e.narrower!=null&&e.narrower.length>0,parents:N.fromJson(e.broader)}}static fromPrefAndUriAndChildren(e,i){return{iri:e.uri,label:e.prefLabel,hasChildren:e.hasChildren,parents:N.fromJson(i)}}static fromLabelAndUriAndChildren(e,i){return{iri:e.uri,label:e.label,hasChildren:e.hasChildren,parents:N.fromJson(i)}}}class A{constructor(e){S(this,"axiosInstance");this.axiosInstance=K.create({baseURL:e,headers:{Accept:"application/json"}})}async makeCall(e,i){return(await this.axiosInstance.get(e,i)).data}async buildHierarchyWithIri(e){var b,s;const{iri:i,ontologyId:d,showSiblingsOnInit:y,parameter:x}=e;if(!d)throw Error("ontologyId has to be specified for SKOS API.");const p=[],u=new Map,f=new Map,E=new Set,m=new Set;if(i){const n=await this.makeCall(`/${d}/hierarchy`,{params:{uri:i,lang:"en",format:"application/json",...R(x)}}).then(o=>Object.keys(o.broaderTransitive).map(l=>o.broaderTransitive[l]));for(const o of n){const l=O.fromHierarchyResult(o);f.set(l.iri,l),o.top&&p.push(l.iri),y||m.add(l.iri)}for(const o of n)if(o.narrower!=null){const l=[];for(const c of o.narrower){let a=f.get(c.uri);a==null?(a=O.fromLabelAndUriAndChildren(c,[o.uri]),f.set(a.iri,a)):(b=a==null?void 0:a.parents)!=null&&b.map(w=>w.value).includes(o.uri)||a!=null&&a.parents&&((s=a==null?void 0:a.parents)==null||s.push(...N.fromJson(o.uri))),l.push(a)}l.sort((c,a)=>(c.label||c.iri).localeCompare(a.label||a.iri)),u.set(o.uri,l.map(c=>({childIri:c.iri}))),E.add(o.uri)}}else{const n=await this.makeCall(`/${d}/topConcepts`,{params:{lang:"en",format:"application/json",...R(x)}}).then(o=>o.topconcepts);for(const o of n)p.push(o.uri)}function I(n,o){o.add(n.iri);const l=new M(n),c=u.get(n.iri)||[];if(y)for(const a of c){if(o.has(a.childIri)){console.error(`Cyclic tree at entity "${a.childIri}".`);continue}const w=f.get(a.childIri);w!=null&&l.addChild(I(w,o))}else for(const a of c){if(o.has(a.childIri)){console.error(`Cyclic tree at entity "${a.childIri}".`);continue}const w=f.get(a.childIri);w!=null&&m.has(a.childIri)&&l.addChild(I(w,o))}return l.loadedChildren.length>0&&(l.expanded=!0),o.delete(n.iri),l}const C=new Set,T=p.map(n=>I(f.get(n),C)).sort((n,o)=>(n.entityData.label||n.entityData.iri).localeCompare(o.entityData.label||o.entityData.iri));return new P({parentChildRelations:u,entitiesData:f,allChildrenPresent:E,roots:T,api:new A(this.axiosInstance.getUri()),ontologyId:d,mainEntityIri:i,keepExpansionStates:e.keepExpansionStates,parameter:x})}async loadHierarchyChildren(e){const{nodeToExpand:i,ontologyId:d,parameter:y}=e;return(await this.makeCall(`/${d}/children`,{params:{uri:i.entityData.iri,lang:"en",format:"application/json",...R(y)}})).narrower.map(p=>O.fromPrefAndUriAndChildren(p,[i.entityData.iri]))}}function _(t){return{iri:t["@id"],label:t.prefLabel,hasChildren:t.hasChildren,parents:[]}}class L{constructor(e,i){S(this,"axiosInstance");S(this,"apiKey");this.axiosInstance=K.create({baseURL:e,headers:{Accept:"application/json"}}),this.apiKey=i,this.axiosInstance.interceptors.request.use(d=>(d.params=d.params||{},d.params.apikey=this.apiKey,d.params.format="json",d))}async makeCall(e,i){return(await this.axiosInstance.get(e,i)).data}async buildHierarchyWithIri(e){const{iri:i,ontologyId:d,entityType:y,showSiblingsOnInit:x}=e;if(!d)throw Error("ontologyId has to be specified for OntoPortal API.");if(!y)throw Error("entityType has to be specified for OntoPortal API.");const p=[],u=new Map,f=new Map,E=new Set,m=new Set;function I(s){if(u.set(s["@id"],_(s)),s.hasChildren&&s.children.length>0){f.set(s["@id"],s.children.map(n=>({childIri:n["@id"]}))),E.add(s["@id"]),m.add(s["@id"]);for(const n of s.children)I(n)}}if(i){const s=await this.makeCall(`/ontologies/${d.toUpperCase()}/${D(y,!1)}/${encodeURIComponent(i)}/tree`,{params:{include:"@id,prefLabel,hasChildren,children",language:"EN"}});for(const n of s)p.push(n["@id"]),m.add(n["@id"]),I(n);m.add(i)}else{const s=await this.makeCall(`/ontologies/${d.toUpperCase()}/${D(y,!1)}/roots`,{params:{include:"@id,prefLabel,hasChildren",language:"EN"}});for(const n of s)p.push(n["@id"]),m.add(n["@id"])}function C(s,n){n.add(s.iri);const o=new M(s),l=f.get(s.iri)||[];if(x)for(const c of l){if(n.has(c.childIri)){console.error(`Cyclic tree at entity "${c.childIri}".`);continue}o.addChild(C(u.get(c.childIri),n))}else for(const c of l){if(n.has(c.childIri)){console.error(`Cyclic tree at entity "${c.childIri}".`);continue}m.has(c.childIri)&&o.addChild(C(u.get(c.childIri),n))}return o.loadedChildren.length>0&&(o.expanded=!0),n.delete(s.iri),o}const T=new Set,b=p.map(s=>C(u.get(s),T)).sort((s,n)=>(s.entityData.label||s.entityData.iri).localeCompare(n.entityData.label||n.entityData.iri));return new P({parentChildRelations:f,entitiesData:u,allChildrenPresent:E,roots:b,api:new L(this.axiosInstance.getUri(),this.apiKey),ontologyId:d,mainEntityIri:i,keepExpansionStates:e.keepExpansionStates,entityType:y})}async loadHierarchyChildren(e){const{nodeToExpand:i,ontologyId:d,entityType:y}=e;if(y==null)throw Error("entityType has to be provided to load children in an OntoPortal hierarchy.");return(await this.makeCall(`/ontologies/${d.toUpperCase()}/${D(y,!1)}/${encodeURIComponent(i.entityData.iri)}/children`,{params:{include:"@id,prefLabel,hasChildren",language:"EN"}})).collection.map(p=>_(p))}}function ae(t){let e=t.entityData.definedBy||[];return e.includes(t.ontologyId)&&(e=[]),r.jsxs("span",{style:{position:"relative",left:"16px",lineHeight:"20px"},children:[r.jsxs("span",{className:t.highlight?"highlight":void 0,children:[t.childRelationToParent=="http://purl.obolibrary.org/obo/BFO_0000050"&&r.jsxs(r.Fragment,{children:[r.jsx("span",{className:"surroundCircle",children:" P "})," "]}),t.childRelationToParent=="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"&&r.jsxs(r.Fragment,{children:[r.jsx("span",{className:"surroundCircle",children:"I"})," "]}),r.jsx("a",{onClick:()=>{t.onNavigateToEntity&&t.onNavigateToEntity(t.ontologyId,t.entityType||"",t.entityData)},style:{textAlign:"left",color:"unset",cursor:"pointer"},children:r.jsx("span",{children:t.entityData.label||t.entityData.iri})})]}),r.jsxs("span",{children:[e.length>0&&r.jsx(r.Fragment,{children:e.map(i=>r.jsxs("span",{children:[" ",r.jsx("button",{onClick:()=>{t.onNavigateToOntology&&t.onNavigateToOntology(i,t.entityType||"",t.entityData)},children:r.jsx("span",{className:"ontology-badge",children:i.toUpperCase()})},`${t.entityData.iri}:${i}`)]}))}),t.entityData.numDescendants!=null&&t.entityData.numDescendants>0&&r.jsxs("span",{style:{color:"gray"},children:[" ","(",t.entityData.numDescendants.toLocaleString(),")"]})]})]})}function re(t){const{apiUrl:e,backendType:i,apiKey:d,onNavigateToEntity:y,onNavigateToOntology:x,iri:p,ontologyId:u,entityType:f,includeObsoleteEntities:E=v.INCLUDE_OBSOLETE_ENTITIES,preferredRoots:m=v.PREFERRED_ROOTS,keepExpansionStates:I=v.KEEP_EXPANSION_STATES,showSiblingsOnInit:C=v.SHOW_SIBLINGS_ON_INIT,useLegacy:T=v.USE_LEGACY,hierarchyWrap:b=v.WRAP,className:s,parameter:n}=t,o=s||"ts4nfdi-hierarchy-style",[,l]=j.useReducer(h=>h+1%Number.MAX_SAFE_INTEGER,0),c=j.useMemo(()=>{switch(i){case"ols":return new H(e);case"skosmos":return new A(e);case"ontoportal":return new L(e,d||"");default:return new H(e)}},[e,i,d]),{data:a,isSuccess:w}=te(["hierarchySemLookP",p,f,u,m,E,I,C,T,n],async function(){return await c.buildHierarchyWithIri({ontologyId:u,iri:p,entityType:f,preferredRoots:m,includeObsoleteEntities:E,keepExpansionStates:I,showSiblingsOnInit:C,useLegacy:T,parameter:n})},{refetchOnWindowFocus:!1}),B=j.useCallback(h=>{if(!(a instanceof P))throw Error("Hierarchy object was undefined while trying to expand a tree node. This should never happen.");a.entityType&&Z(a.entityType)||(h.expanded=!h.expanded,h.expanded?(h.loading=!0,l(),a.fetchInformationForExpansion(h).then(()=>{h.loading=!1,l()})):(l(),a.closeNode(h)))},[a]);function k(h,g,U){return r.jsxs("div",{children:[r.jsxs("div",{style:{position:"relative"},children:[r.jsx("div",{style:{position:"absolute"},children:g.entityData.hasChildren?r.jsxs("button",{style:{},onClick:()=>{B(g)},children:[r.jsx(W,{type:g.expanded?"arrowDown":"arrowRight",size:"s"})," "]}):r.jsx(W,{type:"empty"})}),r.jsx("div",{className:"lineNodeInlet"}),r.jsx("div",{className:U?"lineAfterNodeInlet":""}),r.jsx(ae,{entityData:g.entityData,childRelationToParent:g.childRelationToParent,ontologyId:h.ontologyId,entityType:h.entityType,onNavigateToEntity:typeof y=="function"?y:()=>{},onNavigateToOntology:typeof x=="function"?x:()=>{},highlight:g.entityData.iri==(h==null?void 0:h.mainEntityIri)})]}),g.expanded&&r.jsx("ul",{style:{marginBlockEnd:"0",marginInlineStart:"5px"},children:g.loading?r.jsx($,{style:{position:"relative",left:"13px",top:"5px"}}):g.loadedChildren.map((Q,G)=>r.jsx("div",{className:U?"outerLine":"",style:{paddingLeft:"1rem"},children:k(h,Q,G<g.loadedChildren.length-1)},ee()))})]})}return r.jsx("div",{className:o,children:r.jsx(ie,{"data-testid":"hierarchy",style:{overflowX:"auto",overflowY:"hidden"},children:w&&a!=null?r.jsx(ne,{style:{whiteSpace:b?"wrap":"nowrap"},children:a.roots.map((h,g)=>k(a,h,g<a.roots.length-1))}):r.jsx($,{})})})}function oe(t){const e=new q;return r.jsx(z,{colorMode:"light",globalStyles:!1,children:r.jsx(V,{client:e,children:r.jsx(re,{apiUrl:t.apiUrl,apiKey:t.apiKey,backendType:t.backendType,iri:t.iri,entityType:t.entityType,ontologyId:t.ontologyId,includeObsoleteEntities:t.includeObsoleteEntities,useLegacy:t.useLegacy,preferredRoots:t.preferredRoots,keepExpansionStates:t.keepExpansionStates,showSiblingsOnInit:t.showSiblingsOnInit,onNavigateToEntity:t.onNavigateToEntity,onNavigateToOntology:t.onNavigateToOntology,parameter:t.parameter,hierarchyWrap:t.hierarchyWrap})})})}const F=new WeakMap;function se(t,e){let i=F.get(e);i||(i=Y.createRoot(e),F.set(e,i)),i.render(r.jsx(oe,{...t}))}window.ts4nfdiWidgets={...window.ts4nfdiWidgets,createHierarchy:se};export{re as H,se as c};

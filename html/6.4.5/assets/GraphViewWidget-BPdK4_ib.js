var Ue=Object.defineProperty;var qe=(l,s,n)=>s in l?Ue(l,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[s]=n;var b=(l,s,n)=>qe(l,typeof s!="symbol"?s+"":s,n);import{j as r,r as d}from"./index-Bl-ZOWkZ.js";import{O as ie,Q as Qe,d as Ve,f as Je,L as Ye,v as $e}from"./storyArgs-CoCupxjt.js";import{u as Ze}from"./useQuery-B6EIc2HU.js";import{D as xe,N as Ke}from"./ts4nfdiGraphStyle-DEBK50Pl.js";import{E as ye}from"./panel-DGXMVH66.js";import{E as Xe}from"./button-CZYopU3b.js";import{E as et}from"./popover-CqDBlI6J.js";import{E as we,a as tt}from"./text-DnrTktR3.js";import{E as rt}from"./button_empty-Bh2nXOPv.js";import{E as W}from"./icon-wCPcE0on.js";const Te={enabled:!0,direction:"DU",sortMethod:"directed"},_={autoResize:!0,height:"100%",width:"100%",locale:"en",layout:{randomSeed:1,improvedLayout:!0,clusterThreshold:150,hierarchical:{enabled:!1}},physics:{enabled:!0,barnesHut:{gravitationalConstant:-2e4,centralGravity:.3,springLength:10,springConstant:.04,damping:.09,avoidOverlap:0},hierarchicalRepulsion:{damping:.09,avoidOverlap:.9}},interaction:{dragNodes:!0,dragView:!0,zoomView:!0}};class te{constructor(s,n="#455469",u="white"){b(this,"id");b(this,"color");b(this,"shape");b(this,"font");b(this,"label");this.id=s.iri,this.label=s.label,this.color={background:n,highlight:{border:"#404040",background:"#404040"}},this.shape="box",this.font={color:u}}}class it{constructor(s,n="is a"){b(this,"id");b(this,"from");b(this,"to");b(this,"label");b(this,"arrows");b(this,"width");b(this,"color");b(this,"font");b(this,"dashes");s.source&&s.target&&s.uri&&(this.id=s.source+s.target+"&uri="+s.uri,this.from=s.source,this.to=s.target,this.label=n,this.arrows={to:!0},this.width=2,this.color={color:"gray",highlight:"#00617C"},this.font={size:16})}}async function ot(l){const{api:s,ontologyId:n,iri:u,targetIri:h,dbClicked:E}=l,g=new ie(s);let y=await g.getTermTree({ontologyId:n,termIri:u},{viewMode:"All",siblings:!1});if(h&&!E){let T=await g.getTermTree({ontologyId:n,termIri:h},{viewMode:"All",siblings:!1});return{treeData:y,targetTreeData:T}}return{treeData:y}}async function nt(l){const{api:s,ontologyId:n,iri:u,targetIri:h,dbClicked:E}=l,g=new ie(s);let y=await g.getTermTree({ontologyId:n,termIri:u},{viewMode:"All",siblings:!1}),T=await g.getTermRelations({ontologyId:n,termIri:u});if(h&&!E){let H=await g.getTermTree({ontologyId:n,termIri:h},{viewMode:"All",siblings:!1}),M=await g.getTermRelations({ontologyId:n,termIri:h});return{treeData:y,termRelations:T,targetTreeData:H,targetTermRelations:M}}return{treeData:y,termRelations:T}}async function st(l){const{api:s,ontologyId:n,iri:u,targetIri:h,dbClicked:E}=l,g=new ie(s);let y=await g.getTermRelations({ontologyId:n,termIri:u});if(h&&!E){let T=await g.getTermRelations({ontologyId:n,termIri:h});return{termRelations:y,targetTermRelations:T}}return{termRelations:y}}function Ce(l){let s=[];for(let n of l){if(n.parent==="#"){s.push(n);continue}for(let u of l)u.id===n.parent&&("childrenList"in u?u.childrenList.push(n):u.childrenList=[n],"parentList"in n?n.parentList.push(u):n.parentList=[u])}return s}const z=["http://www.w3.org/2000/01/rdf-schema#subClassOf","hierarchicalParent","directParent"],re="has part";function lt(l){const{api:s,iri:n,ontologyId:u,rootWalk:h,className:E,hierarchy:g,edgeLabel:y,onNodeClick:T}=l,[H,M]=d.useState(n),[I,U]=d.useState(!0),[q,Q]=d.useState(!1),[m,V]=d.useState(!1),[ke,oe]=d.useState(!1),[D,J]=d.useState(0),[ne,Re]=d.useState({nodes:[],edges:[]}),[F,se]=d.useState(""),[Y,je]=d.useState({bgColor:"",color:""}),[ve,le]=d.useState(!1),[$,Z]=d.useState(!1),[A,ae]=d.useState(!1),[C,Se]=d.useState(l.targetIri??""),[ce,Ee]=d.useState(""),[de,Ie]=d.useState(""),Ne=E||"ts4nfdi-graph-style",K=!y||y==="undefined"?"is a":y,Le=typeof T=="function"&&!T.name.includes("actionHandler"),X="#139ec4",L="#708238",ue="#00a86b",ge="#ff991c",j="white",{data:f,isLoading:Ge,isError:Oe,error:De}=Ze(["termGraph",s,u,h,g,m,C,D],async()=>{let e=n;if(m&&(e=H),h&&(I||m)&&!g)return await ot({api:s,iri:e,ontologyId:u,targetIri:C,dbClicked:m});if(h&&(I||m)&&g)return await nt({api:s,iri:e,ontologyId:u,targetIri:C,dbClicked:m});if(I||m)return await st({api:s,iri:e,ontologyId:u,targetIri:C,dbClicked:m})}),x=d.useRef(new xe([])),G=d.useRef(new xe([])),w=d.useRef({}),fe=d.useRef(null),ee=d.useRef(null),P=d.useRef(new Map);if(g&&(_.layout.hierarchical=Te),f&&(I||m)){let e={...ne},i={nodes:[],edges:[]};i=f.termRelations??i,f.treeData&&h&&(I||m)&&!g?i=me(f.treeData,f.termRelations,f.targetTreeData,f.targetTermRelations):f.termRelations&&f.treeData&&h&&(I||m)&&g&&(i=me(f.treeData,f.termRelations,f==null?void 0:f.targetTreeData,f==null?void 0:f.targetTermRelations)),!h&&!g&&(i.nodes=Me(f),i.edges=Fe(f),Q(!0)),I&&(e={nodes:[],edges:[]},U(!1)),m&&V(!1),Re({nodes:[...e.nodes,...(i==null?void 0:i.nodes)??[]],edges:[...e.edges,...(i==null?void 0:i.edges)??[]]}),Q(!0)}function Me(e){var c,t,p;let i=x.current.length;for(let a of((c=e.termRelations)==null?void 0:c.nodes)??[])v(a);let o=[];if(e.targetTermRelations){for(let a of e.targetTermRelations.nodes)(t=e==null?void 0:e.termRelations)!=null&&t.nodes.find(k=>k.iri===a.iri)?v(a,!0):o.push(a);for(let a of o)v(a,!1,L,j)}return i===x.current.length&&Z(!0),[...((p=e.termRelations)==null?void 0:p.nodes)??[],...o]}function Fe(e){var o,c,t,p;for(let a of((o=e.termRelations)==null?void 0:o.edges)??[]){if(!z.includes(a.uri)){O(a,a.label);continue}O(a)}let i=[];if((c=e.targetTermRelations)!=null&&c.edges)for(let a of e.targetTermRelations.edges)(t=e.termRelations)!=null&&t.edges.find(k=>k.source===a.source&&k.target===a.target)||(O(a),i.push(a));return[...((p=e.termRelations)==null?void 0:p.edges)??[],...i]}function v(e,i=!1,o="",c=""){let t=new te(e=e);o&&c&&(t=new te(e=e,L,j)),x.current.get(t.id)?i&&t.id!==n&&t.id!==C&&(t=new te(e=e,ge),x.current.remove(t.id),P.current.set(t.id??"",t.color.background),x.current.add(t)):(t.id===n?(Ee(t.label??""),t.color.background=X,t.font.color=j):C&&t.id===C?(Ie(t.label??""),t.color.background=ue,t.font.color=j):P.current.get(t.id)?t.color.background=P.current.get(t.id):m&&Y.bgColor&&Y.bgColor!==X&&(t.color.background=Y.bgColor,t.font.color=j),P.current.set(t.id??"",t.color.background),x.current.add(t))}function O(e,i=K){var t;let o=new it(e=e,i),c=!(z.includes(e.uri??"")||h);o.dashes=c,G.current.get(o.id)||((t=o.id)!=null&&t.includes(n)&&h&&(o.color.color="black"),G.current.add(o))}function he(e,i,o=!1){let c=[...i],t=[],p=1,a=[],k=x.current.length;for(;;){let R=c[0];c=c.slice(1);let S={iri:R.iri,label:R.text,level:p};if(o?e.nodes.find(N=>N.iri===S.iri)?v(S,!0,L,j):(v(S,!1,L,j),a.find(N=>N.iri===S.iri)||a.push(S)):(e.nodes.find(N=>N.iri===S.iri)||e.nodes.push(S),v(S)),R.parentList&&R.parentList.length!==0&&R.parentList.forEach(N=>{let B={source:R.iri,target:N.iri,label:K,uri:z[0]};e.edges.find(be=>be.source===B.source&&be.target===B.target)||e.edges.push(B),O(B)}),R.childrenList&&R.childrenList.length!==0&&t.push(...R.childrenList),c.length===0){if(t.length===0)break;p+=1,c.push(...t),t=[]}}return e.nodes=[...e.nodes,...a],k===x.current.length&&Z(!0),e}function pe(e,i,o=!1){if(!i)return;let c="",t="";o&&(c=L,t=j);let p={nodes:[],edges:[]};for(let a of i.edges)a.label===re&&(O(a,re),v(i.nodes.find(k=>k.iri===a.source),!1,c,t),v(i.nodes.find(k=>k.iri===a.target),!1,c,t));e.nodes=e.nodes.concat(p.nodes),e.edges=e.edges.concat(p.edges)}function me(e,i,o,c){let t={nodes:[],edges:[]},p=Ce(e);if(he(t,p),m||pe(t,i),C&&o){let a=Ce(o);he(t,a,!0),m||pe(t,c,!0)}return t}function Ae(){const e=JSON.stringify(ne,null,2),i=new Blob([e],{type:"application/json"}),o=document.createElement("a");o.href=URL.createObjectURL(i),o.download=`graphData_${u}_${n}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o)}function Pe(){x.current.clear(),G.current.clear(),M(n),U(!0),V(!1),J(D+1)}function Be(){if(!F)le(!0),setTimeout(()=>{le(!1)},3e3);else{let e=[],i=[];G.current.forEach((o,c)=>{o.label!==re&&(o.to===F?e.push(o.from):o.from===F&&i.push(o.to))});for(let o of e)for(let c of i){let t={source:o,target:c,label:K,uri:z[0]};O(t)}x.current.remove(F),w.current.setOptions({physics:!0}),setTimeout(()=>{w.current.setOptions({physics:!1})},4e3)}}d.useEffect(()=>{if(!q)return;let e={nodes:x.current,edges:G.current},i=JSON.parse(JSON.stringify(_));w.current=new Ke(fe.current,e,i),setTimeout(()=>{w.current.setOptions({physics:!1})},4e3)},[D,q]),d.useEffect(()=>{w.current&&q&&(w.current.on("click",function(e){e.nodes.length>0?se(e.nodes[0]):se("")}),w.current.on("doubleClick",function(e){var i,o,c,t;if(e.nodes.length>0){let p=e.nodes[0];je({bgColor:(o=(i=x.current.get(p))==null?void 0:i.color)==null?void 0:o.background,color:(t=(c=x.current.get(p))==null?void 0:c.font)==null?void 0:t.color}),M(p),Le?T(p):V(!0)}}))},[w.current]),d.useEffect(()=>{l.targetIri&&C!==l.targetIri&&(Q(!1),w.current.destroy(),x.current.clear(),G.current.clear(),Se(l.targetIri),U(!0),J(D+1))},[l.targetIri]),d.useEffect(()=>{g?_.layout.hierarchical=Te:_.layout.hierarchical={enabled:!1},J(D+1)},[g]),d.useEffect(()=>{m&&(w.current.setOptions({physics:!0}),setTimeout(()=>{w.current.setOptions({physics:!1})},4e3))},[m]),d.useEffect(()=>{$&&setTimeout(()=>{Z(!1)},3e3)},[$]);const We=()=>oe(e=>!e),_e=()=>oe(!1),ze=r.jsx(rt,{iconType:"iInCircle",iconSide:"right",onClick:We,children:"Guide me"}),He=()=>{document.fullscreenElement?(document.exitFullscreen(),ae(!1)):ee.current&&(ee.current.requestFullscreen(),ae(!0))};return r.jsx("div",{className:Ne,style:{width:"1000px",height:"100vh",overflow:"hidden"},ref:ee,children:r.jsxs(ye,{style:{height:"100vh"},"data-testid":"graph-widget",children:[Oe&&r.jsx(we,{children:Ye(De,"graph")}),r.jsxs(ye,{style:{fontSize:12},paddingSize:"s",borderRadius:"none","data-testid":"graph-view",children:[r.jsx(Xe,{size:"s",onClick:Pe,"aria-label":"reset the graph to default view",title:"Reset the graph to the original state.",style:{textDecoration:"none"},children:"Reset"}),!A&&r.jsx(et,{button:ze,isOpen:ke,closePopover:_e,children:r.jsxs(we,{style:{width:300,padding:10},children:[r.jsx("li",{children:"Expand the nodes by double clicking on them"}),r.jsx("li",{children:"Zoom out/in by scrolling on the graph."}),r.jsx("li",{children:"Go to fullscreen mode by clicking the fullscreen icon on the right corner."}),r.jsx("li",{children:"Download the graph data as JSON by clicking the download icon on the right corner."}),r.jsx("li",{children:"You can go back to the initial graph by clicking on the Reset button."}),r.jsx("li",{children:"You can move the nodes and edges around by dragging."})]})}),$&&r.jsx("div",{style:{display:"inline-block",backgroundColor:"#FBCBC6",color:"red",padding:"5px",borderRadius:"10px"},children:"nothing to add"}),r.jsxs("div",{style:{display:"inline-flex",float:"right",paddingTop:10},children:[r.jsx("button",{onClick:Be,style:{marginRight:"20px",color:"red"},title:"Remove node","aria-label":"remove the selected node from graph",children:r.jsx(W,{type:"cut"})}),ve&&r.jsx(tt,{color:"red",style:{marginTop:"10px",marginRight:"10px",marginLeft:"-10px"},children:"Please select a node to remove"}),r.jsx("button",{onClick:Ae,title:"Download graph data as json.","aria-label":"download graph data as json",children:r.jsx(W,{type:"download"})}),r.jsx("button",{onClick:He,style:{marginLeft:"20px"},title:A?"Exit fullscreen mode":"Fullscreen mode","aria-label":A?"exit fullscreen mode":"go to fullscreen mode",children:A?r.jsx(W,{type:"fullScreenExit"}):r.jsx(W,{type:"fullScreen"})})]})]}),Ge&&r.jsx($e,{size:"m"}),r.jsx("div",{ref:fe,className:"graph-container",style:{width:"100%",height:"100vh",margin:"auto"}}),r.jsxs("div",{style:{position:"absolute",display:"inline-block",backgroundColor:"#e5e7ea",padding:"5px",borderRadius:"10px",paddingTop:"10px",bottom:"20px",right:"20px"},children:[r.jsx("b",{children:"Legend:"}),r.jsxs("ul",{style:{paddingTop:"15px"},children:[r.jsxs("li",{style:{paddingTop:"5px"},children:[r.jsx("div",{style:{backgroundColor:X,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block"}}),"  Source: ",r.jsx("i",{children:ce})," "]}),C&&r.jsxs(r.Fragment,{children:[r.jsxs("li",{style:{paddingTop:"5px"},children:[r.jsx("div",{style:{backgroundColor:"#455469",width:"10px",height:"10px",borderRadius:"50%",display:"inline-block"}}),"  Subtree exclusive to ",r.jsx("i",{children:ce})," "]}),r.jsxs("li",{style:{paddingTop:"5px"},children:[r.jsx("div",{style:{backgroundColor:ge,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block"}}),"  Common subtree "]}),r.jsxs("li",{style:{paddingTop:"5px"},children:[r.jsx("div",{style:{backgroundColor:ue,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block"}})," Target: ",r.jsx("i",{children:de})," "]}),r.jsxs("li",{style:{paddingTop:"5px"},children:[r.jsx("div",{style:{backgroundColor:L,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block"}}),"  Subtree exclusive to ",r.jsx("i",{children:de})," "]})]})]})]}),r.jsx("style",{children:`
        .graph-container:fullscreen,
        .graph-container::backdrop {
          background-color: white;
        }
      `})]})})}function yt(l){const s=new Qe;return r.jsx(Ve,{colorMode:"light",globalStyles:!1,children:r.jsx(Je,{client:s,children:r.jsx(lt,{api:l.api,iri:l.iri,ontologyId:l.ontologyId,rootWalk:l.rootWalk,hierarchy:l.hierarchy,edgeLabel:l.edgeLabel,onNodeClick:l.onNodeClick,targetIri:l.targetIri})})})}export{lt as G,yt as W};

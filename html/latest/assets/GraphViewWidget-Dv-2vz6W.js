var de=Object.defineProperty;var he=(n,c,d)=>c in n?de(n,c,{enumerable:!0,configurable:!0,writable:!0,value:d}):n[c]=d;var l=(n,c,d)=>he(n,typeof c!="symbol"?c+"":c,d);import{j as r,r as a}from"./index-ZCdkkhYt.js";import{Q as ue,d as fe,f as ge,O as pe,L as me,v as be}from"./storyArgs-AFjXh7XW.js";import{u as we}from"./useQuery-BSQecOR7.js";import{D as H,N as U,E as K}from"./ts4nfdiGraphStyle-pEL6bT6-.js";import{E as X}from"./panel-DRTqr2vT.js";import{E as ye}from"./button-7mVtQWS6.js";import{E as ke}from"./popover-DSoekXbz.js";import{E as Ee}from"./button_empty-C2K4yniN.js";import{E as Z}from"./text-dCu-lByA.js";function xe(n){var V;const{api:c,iri:d,ontologyId:b,rootWalk:y,className:_,hierarchy:v,edgeLabel:I,onNodeClick:L}=n,[N,T]=a.useState(d),[p,O]=a.useState(!0),[j,R]=a.useState(!1),[h,P]=a.useState(y||!1),[f,W]=a.useState(!!v),[$,z]=a.useState(!1),[B,J]=a.useState(0),S=new pe(c),ee=_||"ts4nfdi-graph-style",te=!I||I==="undefined"?"is a":I,Y=typeof L=="function"&&!L.name.includes("mockConstructor"),{data:g,isLoading:re,isError:ie,error:oe}=we(["termGraph",c,N,b,h,j,B],async()=>{if(h&&p&&!f)return{treeData:await S.getTermTree({ontologyId:b,termIri:d},{viewMode:"All",siblings:!1})};if(h&&p&&f){let i=await S.getTermTree({ontologyId:b,termIri:d},{viewMode:"All",siblings:!1}),e=await S.getTermRelations({ontologyId:b,termIri:N});return{treeData:i,termRelations:e}}else if(p||j)return{termRelations:await S.getTermRelations({ontologyId:b,termIri:N})}}),k=a.useRef(new H([])),E=a.useRef(new H([])),w=a.useRef({}),G=a.useRef(null),M={enabled:!0,direction:"DU",sortMethod:"directed"},x={autoResize:!0,height:"100%",width:"100%",locale:"en",layout:{randomSeed:1,improvedLayout:!0,clusterThreshold:150,hierarchical:{enabled:!1}},physics:{enabled:!0,barnesHut:{gravitationalConstant:-2e4,centralGravity:.3,springLength:10,springConstant:.04,damping:.09,avoidOverlap:0},hierarchicalRepulsion:{damping:.09,avoidOverlap:.9}}};f&&(x.layout.hierarchical=M);class se{constructor({node:e}){l(this,"id");l(this,"label");l(this,"color");l(this,"shape");l(this,"font");this.id=e.iri,this.label=e.label,this.color={background:"#455469",highlight:{border:"#404040",background:"#404040"}},this.shape="box",this.font={color:"white"}}}class ae{constructor({edge:e}){l(this,"id");l(this,"from");l(this,"to");l(this,"label");l(this,"arrows");l(this,"width");l(this,"color");l(this,"font");l(this,"dashes");e.source&&e.target&&e.uri&&(this.id=e.source+e.target+"&uri="+e.uri,this.from=e.source,this.to=e.target,this.label=e.label,this.arrows={to:!0},this.width=2,this.color={color:"gray",highlight:"#00617C"},this.font={size:16})}}if(g&&(p||j)){let i=g.termRelations;g.treeData&&h&&p&&!f?i=A(g.treeData,void 0):g.termRelations&&g.treeData&&h&&p&&f&&(i=A(g.treeData,g.termRelations));for(let e of i.nodes){let o=new se({node:e});k.current.get(o.id)||(o.id===d&&h&&(o.color.background="#0BBBEF",o.font.color="black"),k.current.add(o))}for(let e of i.edges){let o=new ae({edge:e}),u=!(e.uri==="http://www.w3.org/2000/01/rdf-schema#subClassOf"||h);o.dashes=u,E.current.get(o.id)||((V=o.id)!=null&&V.includes(d)&&h&&(o.color.color="black"),E.current.add(o))}p&&O(!1),j&&R(!1)}function A(i,e){let o=[];for(let t of i){if(t.parent==="#"){o.push(t);continue}for(let s of i)s.id===t.parent&&("childrenList"in s?s.childrenList.push(t):s.childrenList=[t],"parentList"in t?t.parentList.push(s):t.parentList=[s])}let u={nodes:[],edges:[]},C=[...o],D=[],q=1;for(;;){let t=C[0];if(C=C.slice(1),!u.nodes.find(s=>s.iri===t.iri)){let s={iri:t.iri,label:t.text,level:q};u.nodes.push(s)}if(t.parentList&&t.parentList.length!==0&&t.parentList.forEach(s=>{let m={source:t.iri,target:s.iri,label:te,uri:"http://www.w3.org/2000/01/rdf-schema#subClassOf"};u.edges.find(F=>F.source===m.source&&F.target===m.target)||u.edges.push(m)}),t.childrenList&&t.childrenList.length!==0&&D.push(...t.childrenList),C.length===0){if(D.length===0)break;q+=1,C.push(...D),D=[]}}if(e){let t={nodes:[],edges:[]};for(let s of e.edges)s.label==="has part"&&(t.edges.push(s),t.nodes.push(e.nodes.find(m=>m.iri===s.source)),t.nodes.push(e.nodes.find(m=>m.iri===s.target)));u.nodes=u.nodes.concat(t.nodes),u.edges=u.edges.concat(t.edges)}return u}function Q(){k.current.clear(),E.current.clear(),T(d),O(!0),R(!1),J(B+1)}a.useEffect(()=>{let i={nodes:k.current,edges:E.current};w.current=new U(G.current,i,x)},[]),a.useEffect(()=>{w.current&&w.current.on("doubleClick",function(i){if(i.nodes.length>0){let e=i.nodes[0];T(e),Y?L(e):R(!0)}})},[w]),a.useEffect(()=>{Q()},[h,c,b,d]),a.useEffect(()=>{P(y||!1)},[y]),a.useEffect(()=>{W(v||!1)},[v]),a.useEffect(()=>{f?x.layout.hierarchical=M:delete x.layout.hierarchical;let i={nodes:k.current,edges:E.current};w.current=new U(G.current,i,x),w.current.on("doubleClick",function(e){if(e.nodes.length>0){let o=e.nodes[0];T(o),Y?L(o):R(!0)}})},[f]);const ne=()=>z(i=>!i),le=()=>z(!1),ce=r.jsx(Ee,{iconType:"iInCircle",iconSide:"right",onClick:ne,children:"Guide me"});return r.jsxs("div",{className:ee,children:[ie&&r.jsx(Z,{children:me(oe,"graph")}),r.jsxs(X,{style:{fontSize:12},paddingSize:"s",borderRadius:"none","data-testid":"graph-view",children:[r.jsx(ye,{size:"s",onClick:Q,children:"Reset"}),r.jsx(ke,{button:ce,isOpen:$,closePopover:le,children:r.jsxs(Z,{style:{width:300,padding:10},children:[r.jsx("li",{children:"You can expand the nodes by double clicking on them"}),r.jsx("li",{children:"You can zoom out/in by scrolling on the graph."}),r.jsx("li",{children:"You can go back to the initial graph by clicking on the Reset button."}),r.jsx("li",{children:"You can move the nodes and edges around by dragging."}),r.jsx("li",{children:"Rootwalk toggle enable the root walk mode in the graph, where you can see the path from roots to the target node."})]})}),r.jsxs("div",{style:{display:"inline-block",float:"right",paddingTop:10},children:[r.jsx(K,{label:"root walk",checked:h,onChange:()=>{P(!h)},title:"Enable the root walk mode in the graph: You can see the path from roots to the target node"}),r.jsx(K,{label:"hierarchy",checked:f,onChange:()=>{W(!f)},title:"Enable the root walk mode in the graph: You can see the path from roots to the target node"})]})]}),r.jsxs(X,{style:{width:900,height:900},hasShadow:!1,hasBorder:!0,borderRadius:"none",children:[re&&r.jsx(be,{size:"m"}),r.jsx("div",{ref:G,className:"graph-container",style:{width:"850px",height:"850px",margin:"auto"}})]})]})}function Ge(n){const c=new ue;return r.jsx(fe,{colorMode:"light",globalStyles:!1,children:r.jsx(ge,{client:c,children:r.jsx(xe,{api:n.api,iri:n.iri,ontologyId:n.ontologyId,rootWalk:n.rootWalk,hierarchy:n.hierarchy,edgeLabel:n.edgeLabel,onNodeClick:n.onNodeClick})})})}export{xe as G,Ge as W};
